
import { GroupBox, ListView, CheckBox, Button, Palette, LineEdit, VerticalBox, HorizontalBox, ComboBox } from "std-widgets.slint";
import { Style } from "style.slint";
import { Notes, NoteItem } from "notes_view.slint";

export enum ChangeType {
    Invalid,
    Added,
    Copied,
    Deleted,
    Modified,
    Renamed,
    TypChanged,
    Unmerged,
    Unknown,
    Broken,
}

export global ChangeTypeUtils {
    public pure function to_icon(change_type: ChangeType) -> image {
        if (change_type == ChangeType.Added) {
            return @image-url("../assets/icons/git_file_added.svg");
        }
        else if (change_type == ChangeType.Broken) {
            return @image-url("../assets/icons/git_file_broken.svg");
        }
        else if (change_type == ChangeType.Copied) {
            return @image-url("../assets/icons/git_file_copied.svg");
        }
        else if (change_type == ChangeType.Deleted) {
            return @image-url("../assets/icons/git_file_deleted.svg");
        }
        else if (change_type == ChangeType.Modified) {
            return @image-url("../assets/icons/git_file_edited.svg");
        }
        else if (change_type == ChangeType.Renamed) {
            return @image-url("../assets/icons/git_file_renamed.svg");
        }
        else if (change_type == ChangeType.TypChanged) {
            return @image-url("../assets/icons/git_file_type_changed.svg");
        }
        else if (change_type == ChangeType.Unknown) {
            return @image-url("../assets/icons/git_file_unknown.svg");
        }
        else if (change_type == ChangeType.Unmerged) {
            return @image-url("../assets/icons/git_file_unmerged.svg");
        }
        return @image-url("../assets/icons/invalid.svg");
    }
}

export enum SortCriteria {
    Name,
    Extension
}

export struct DiffFileItem {
    id: int,
    added_lines: int,
    removed_lines: int,
    text: string,
    is_reviewed: bool,
    change_type: ChangeType,
}

export global Diff {
    in property <string> start_commit;
    in property <string> end_commit;
    in property <[DiffFileItem]> diff_model;
    in property <SortCriteria> current_sort_criteria: SortCriteria.Name;
    callback diff-start-end(string, string);
    callback open-file-diff(int);
    callback open-file(string);
    callback toggle-is-reviewed(int);
    callback set-sort-criteria(SortCriteria);
    callback filter-file-diff(string);
}


export component FileDiffView inherits VerticalBox {
    callback open-file-notes-popup(string);

    private property <int> checked_id: -1;

    spacing: Style.spacing;

    HorizontalLayout {
        spacing: Style.spacing;

        LineEdit {
            horizontal-alignment: left;
            placeholder-text: "Filter paths";
            changed text => { Diff.filter-file-diff(self.text); }
        }
        ComboBox {
            width: 220px;
            model: ["Name", "Extension"];
            current-value: {
                if Diff.current_sort_criteria == SortCriteria.Name {
                    return "Name";
                }
                return "Extension";
            }
            selected(current-criteria) => {
                if current-criteria == "Name" {
                    Diff.set-sort-criteria(SortCriteria.Name);
                }
                else {
                    Diff.set-sort-criteria(SortCriteria.Extension);
                }
            }
        }
    }
    ListView {
        padding-right: 0;
        padding-left: 0;
        for data[idx] in Diff.diff_model: Rectangle {
            property <[NoteItem]> notes: Notes.file-notes-model(data.text);

            background: checked_id == data.id ? #333232 : Palette.background;
            height: Style.control_height;

            HorizontalLayout {
                alignment: space-between;
                spacing: 2px;

                file-text := Text {
                    overflow: elide;
                    font-size: 14px;
                    text: data.text;
                    vertical-alignment: center;
                    horizontal-alignment: left;
                }
                buttons-layout := HorizontalLayout {
                    width: 220px;

                    Image {
                        source: ChangeTypeUtils.to_icon(data.change_type);
                        horizontal-alignment: center;
                    }
                    HorizontalLayout {
                        padding-top: Style.spacing / 2;
                        padding-bottom: Style.spacing / 2;
                        spacing: Style.spacing;

                        Rectangle {
                            background: #5e8262;
                            border-radius: 5px;
                            width: 40px;
                            visible: data.added-lines != 0;

                            Text {
                                font-size: 14px;
                                vertical-alignment: center;
                                text: "\{data.added-lines != -1 ? data.added-lines : "??"}";
                            }
                        }
                        Rectangle {
                            background: #B06161;
                            border-radius: 5px;
                            width: 40px;
                            visible: data.removed-lines != 0;

                            Text {
                                font-size: 14px;
                                vertical-alignment: center;
                                text: "\{data.removed-lines != -1 ? data.removed-lines : "??"}";
                            }
                        }
                        Button {
                            icon: self.checked ? @image-url("../assets/icons/checked.svg") : @image-url("../assets/icons/unchecked.svg");
                            checked: data.is_reviewed;
                            clicked => { Diff.toggle-is-reviewed(data.id) }
                        }
                        property <Point> p: {
                            x: (root.width - bb.width) - 280px,
                            y: bb.height
                        };
                        bb := Button {
                            icon: @image-url("../assets/icons/menu.svg");
                            clicked => { action_popup.show(); }
                        }
                        action_popup := PopupWindow {
                            private property <length> delegate_height: 30px;
                            private property <[string]> action_model: ["diff", "open", "notes"];

                            x: bb.x - (self.width - bb.width);
                            y: bb.height + Style.border_width;
                            width: Style.control_width;
                            height: action_model.length * delegate_height;
                            close-policy: close-on-click-outside;

                            Rectangle {
                                width: 100%;
                                height: 100%;
                                background: Style.popup_background;
                                border-color: Style.popup_border_color;
                                border-width: Style.border_width;

                                VerticalLayout {
                                    for action[idx] in action_model: VerticalLayout {
                                        height: delegate_height;
                                        Rectangle {
                                            background: ta.has-hover ? #4f4b4b : Style.popup_background;
                                            border-color: Style.popup_border_color;
                                            border-width: Style.border_width;

                                            Text {
                                                text: action;
                                            }
                                            ta := TouchArea {
                                                clicked => {
                                                    if (action == "notes") {
                                                        root.open-file-notes-popup(data.text);
                                                    }
                                                    if (action == "diff") {
                                                        Diff.open-file-diff(data.id);
                                                    }
                                                    if (action == "open") {
                                                        Diff.open-file(data.text);
                                                    }
                                                    action_popup.close();
                                                }
                                            }
                                        }
                                        if idx < (action_model.length - 1) : Rectangle {
                                            height: 1px;
                                            width: 100%;
                                            background: #4f4b4b;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            TouchArea {
                x: 0;
                y: 0;
                width: parent.width - buttons-layout.width;
                clicked => { checked_id = data.id }
            }
        }
    }
}
