import { LineEdit, Button, VerticalBox, HorizontalBox, Palette, StandardTableView } from "std-widgets.slint";
import { Style } from "style.slint";
import { CommitPickerAdapter } from "globals.slint";
import { ImageButton } from "image_button.slint";

export component CommitPicker inherits PopupWindow {
    private property <bool> is_sort_ascending: true;

    x: 20px;
    y: 20px;
    height: 600px;
    width: 840px;
    close-policy: close-on-click-outside;

    callback accepted(string);

    Rectangle {
        height: 100%;
        width: 100%;
        background: Palette.background;
        border-color: Palette.border;
        border-width: Style.size.border_width;
        border-radius: Style.size.menu_border_radius;

        VerticalBox {
            HorizontalLayout {
                spacing: Style.size.spacing;

                base_branch_edit := LineEdit {
                    placeholder-text: "base branch";
                }

                ImageButton {
                    source: @image-url("../assets/icons/location.svg");
                    enabled: !base_branch_edit.text.is-empty;
                    text: "Merge-Branch";
                    clicked => {
                        commit_table_view.set-current-row(CommitPickerAdapter.branch_merge_base(base_branch_edit.text));
                    }
                }
            }

            HorizontalLayout {
                spacing: Style.size.spacing;

                LineEdit {
                    placeholder-text: "text filter";
                    edited(text) => {
                        CommitPickerAdapter.filter_commits(text)
                    }
                }

                ImageButton {
                    source: @image-url("../assets/icons/refresh.svg");
                    clicked => {
                        CommitPickerAdapter.refresh()
                    }
                }
            }

            commit_table_view := StandardTableView {
                columns: [
                    { title: "Commit", width: 100px, sort_order: SortOrder.unsorted },
                    { title: "Message", width: 390px },
                    { title: "Author", width: 140px },
                    { title: "Date", sort_order: SortOrder.descending },
                ];
                rows: CommitPickerAdapter.commit_model;
                sort-ascending(column) => {
                    if (column > 0) {
                        CommitPickerAdapter.sort_commits(column, true)
                    }
                }
                sort-descending(column) => {
                    if (column > 0) {
                        CommitPickerAdapter.sort_commits(column, false)
                    }
                }
            }

            HorizontalBox {
                alignment: end;
                Button {
                    height: Style.size.control_height;
                    text: "Cancel";
                    clicked => {
                        root.close()
                    }
                }

                Button {
                    height: Style.size.control_height;
                    text: "Apply";
                    clicked => {
                        root.accepted(CommitPickerAdapter.commit_model[commit_table_view.current-row][0].text);
                        root.close();
                    }
                }
            }
        }
    }
}
